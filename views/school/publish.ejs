<%- include('../partials/head') %>

<%- include('../partials/sidebar_school') %>
<div class="sidebar-overlay" onclick="closeSidebar()"></div>

<div class="app-layout">
  <div class="main-content">
    <div class="mobile-header">
      <button class="hamburger-btn" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
      </button>
      <div class="logo-area">
        <span style="font-size:24px">üçµ</span>
        <span class="font-bold">Publish</span>
      </div>
      <button class="theme-pill" onclick="toggleTheme()">
        <span class="theme-icon">‚òÄÔ∏è</span>
      </button>
    </div>

    <%- include('../partials/topbar', { shell: 'school' }) %>

    <div class="page-content">
      <h2 class="mb-4">Publish Content</h2>

      <div class="grid grid-2">
        <!-- Create Event Form -->
        <div class="card">
          <h3 class="mb-3">
            <span class="material-icons-round" style="vertical-align:middle;margin-right:8px;font-size:20px;">add_circle</span>
            Create New Event
          </h3>

          <form action="/api/events" method="POST" id="eventForm">
            <input type="hidden" name="creator_id" value="<%= user.uid %>">

            <div style="margin-bottom:16px;">
              <label class="text-xs font-semibold text-secondary" style="display:block;margin-bottom:6px;">Event Title *</label>
              <input type="text" name="event_title" class="form-input" placeholder="e.g. Hackathon 2025" required>
            </div>

            <div style="margin-bottom:16px;">
              <label class="text-xs font-semibold text-secondary" style="display:block;margin-bottom:6px;">Date *</label>
              <input type="date" name="date" class="form-input" required>
            </div>

            <div style="margin-bottom:16px;">
              <label class="text-xs font-semibold text-secondary" style="display:block;margin-bottom:6px;">Location</label>
              <input type="text" name="location" class="form-input" placeholder="e.g. Main Campus Hall A">
            </div>

            <div style="margin-bottom:16px;">
              <label class="text-xs font-semibold text-secondary" style="display:block;margin-bottom:6px;">Description</label>
              <textarea name="description" class="form-input" rows="4" placeholder="Describe the event..."></textarea>
            </div>

            <div style="margin-bottom:16px;">
              <label class="text-xs font-semibold text-secondary" style="display:block;margin-bottom:6px;">Target Major</label>
              <input type="text" name="target_major" class="form-input" placeholder="e.g. Computer Science (leave blank for all)">
            </div>

            <div style="display:flex;gap:16px;margin-bottom:16px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" name="is_official" value="true">
                <span class="text-sm">Official Event</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" name="is_all_majors" value="true" checked>
                <span class="text-sm">All Majors</span>
              </label>
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%;">
              <span class="material-icons-round" style="font-size:18px;margin-right:6px;">publish</span>
              Publish Event
            </button>
          </form>
        </div>

        <!-- Existing Events -->
        <div class="card">
          <h3 class="mb-3">
            <span class="material-icons-round" style="vertical-align:middle;margin-right:8px;font-size:20px;">event_note</span>
            Your Events (<%= events.length %>)
          </h3>

          <% if (events.length > 0) { %>
            <% events.forEach(event => { %>
              <div class="event-card" style="margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                  <div>
                    <div class="font-semibold"><%= event.event_title %></div>
                    <div class="text-xs text-secondary mt-1">
                      <span class="material-icons-round" style="font-size:14px;vertical-align:middle;">calendar_today</span>
                      <%= event.date || 'TBA' %>
                      &nbsp;&middot;&nbsp;
                      <span class="material-icons-round" style="font-size:14px;vertical-align:middle;">location_on</span>
                      <%= event.location || 'TBA' %>
                    </div>
                    <% if (event.target_major && !event.is_all_majors) { %>
                      <div class="text-xs mt-1">
                        <span class="chip" style="font-size:10px;padding:2px 8px;"><%= event.target_major %></span>
                      </div>
                    <% } %>
                  </div>
                  <div class="flex gap-1">
                    <% if (event.is_official) { %>
                      <span class="chip chip-primary" style="font-size:10px;padding:2px 8px;">Official</span>
                    <% } %>
                    <% if (event.is_all_majors) { %>
                      <span class="chip chip-secondary" style="font-size:10px;padding:2px 8px;">All Majors</span>
                    <% } %>
                  </div>
                </div>
                <% if (event.description) { %>
                  <div class="text-sm text-secondary mt-2"><%= event.description %></div>
                <% } %>
              </div>
            <% }); %>
          <% } else { %>
            <div class="text-secondary text-center" style="padding:32px;">
              <span class="material-icons-round" style="font-size:48px;display:block;margin-bottom:12px;opacity:.4;">event_busy</span>
              No events published yet.<br>Use the form to create your first event.
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('eventForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const body = {};
    formData.forEach((val, key) => { body[key] = val; });
    body.is_official = body.is_official === 'true';
    body.is_all_majors = body.is_all_majors === 'true';

    try {
      const res = await fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        window.location.reload();
      } else {
        alert('Failed to create event. Please try again.');
      }
    } catch (err) {
      console.error(err);
      alert('Error creating event.');
    }
  });
</script>

<%- include('../partials/footer') %>
