<%- include('../partials/head') %>

<%- include('../partials/sidebar_student') %>
<div class="sidebar-overlay" onclick="closeSidebar()"></div>

<div class="app-layout">
  <div class="main-content">
    <div class="mobile-header">
      <button class="hamburger-btn" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
      </button>
      <div class="logo-area">
        <span style="font-size:24px">üçµ</span>
        <span class="font-bold">Teams</span>
      </div>
      <button class="theme-pill" onclick="toggleTheme()">
        <span class="theme-icon">‚òÄÔ∏è</span>
      </button>
    </div>

    <%- include('../partials/topbar', { shell: 'student' }) %>

    <div class="page-content">
      <h2 class="mb-6">Teams & Pairing</h2>

      <!-- AI Banner -->
      <div class="ai-banner">
        <h3><span class="material-icons-round" style="vertical-align:middle;margin-right:8px;">psychology</span>AI Team Matching</h3>
        <p>Our AI analyzes skill tags, project interests, and collaboration preferences to find your ideal teammates.</p>
      </div>

      <!-- Wizard Steps -->
      <div style="display:flex;gap:12px;margin-bottom:32px;">
        <div class="chip" id="step1Chip" style="padding:8px 20px;cursor:pointer;font-weight:600;" onclick="showStep(1)">1. Room</div>
        <div class="chip chip-purple" id="step2Chip" style="padding:8px 20px;cursor:pointer;font-weight:600;opacity:0.5;" onclick="showStep(2)">2. Teammates</div>
        <div class="chip chip-pink" id="step3Chip" style="padding:8px 20px;cursor:pointer;font-weight:600;opacity:0.5;" onclick="showStep(3)">3. Finalize</div>
      </div>

      <!-- Step 1: Room -->
      <div id="step1" class="section">
        <h3 class="section-title mb-4">Collaboration Posts</h3>
        <div class="grid-2">
          <% posts.slice(0, 8).forEach(post => { %>
            <div class="card">
              <div class="flex items-center gap-3 mb-3">
                <div class="avatar" style="width:32px;height:32px;font-size:12px;"><%= (post.title || 'P').charAt(0) %></div>
                <div>
                  <div class="font-semibold text-sm"><%= post.title || 'Untitled Post' %></div>
                  <div class="text-xs text-secondary"><%= post.type || 'General' %> &bull; <span class="chip chip-green" style="font-size:10px;padding:2px 6px;"><%= post.status || 'Open' %></span></div>
                </div>
              </div>
              <p class="text-sm text-secondary mb-3"><%= post.description ? post.description.substring(0, 120) + '...' : 'No description' %></p>
              <div class="tags-container mb-3">
                <% if (post.resolvedRequirements && post.resolvedRequirements.length > 0) { %>
                  <% post.resolvedRequirements.slice(0, 4).forEach(tag => { %>
                    <span class="chip"><%= tag %></span>
                  <% }); %>
                <% } %>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="showStep(2)">Join Room</button>
                <button class="btn btn-ghost btn-sm">Details</button>
              </div>
            </div>
          <% }); %>
          <% if (posts.length === 0) { %>
            <div class="empty-state" style="grid-column:1/-1;">
              <div class="icon">üè†</div>
              <h3>No rooms available</h3>
              <p>Create a new room or wait for others to post.</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Step 2: Teammates -->
      <div id="step2" class="section" style="display:none;">
        <h3 class="section-title mb-4">AI-Matched Candidates</h3>
        <div class="grid-2">
          <% matches.slice(0, 6).forEach(match => { %>
            <div class="match-card">
              <div class="match-score <%= match.score >= 0.85 ? 'score-high' : match.score >= 0.7 ? 'score-mid' : 'score-low' %>">
                <%= match.score ? Math.round(match.score * 100) + '%' : '‚Äî' %>
              </div>
              <div style="flex:1;min-width:0;">
                <div class="font-semibold text-sm"><%= match.match_type === 'AI_Recommendation' ? 'ü§ñ AI Match' : '‚úã Application' %></div>
                <div class="text-secondary text-xs" style="margin-top:4px;"><%= match.reason ? match.reason.substring(0, 100) : 'Compatible profile' %></div>
                <div style="margin-top:8px;display:flex;gap:8px;">
                  <span class="chip <%= match.match_status === 'Accepted' ? 'chip-green' : match.match_status === 'Rejected' ? 'chip-red' : 'chip-amber' %>">
                    <%= match.match_status || 'Pending' %>
                  </span>
                  <button class="btn btn-ghost btn-sm" style="padding:4px 8px;" onclick="showStep(3)">Accept ‚Üí</button>
                </div>
              </div>
            </div>
          <% }); %>
          <% if (matches.length === 0) { %>
            <div class="empty-state" style="grid-column:1/-1;">
              <div class="icon">ü§ñ</div>
              <h3>No matches found</h3>
              <p>Join a room first, then AI will find compatible teammates.</p>
            </div>
          <% } %>
        </div>
        <div style="margin-top:24px;">
          <button class="btn btn-secondary" onclick="showStep(1)">‚Üê Back to Rooms</button>
          <button class="btn btn-primary" style="margin-left:8px;" onclick="showStep(3)">Proceed to Finalize ‚Üí</button>
        </div>
      </div>

      <!-- Step 3: Finalize -->
      <div id="step3" class="section" style="display:none;">
        <div class="card" style="max-width:600px;">
          <h3 class="mb-4">üéâ Finalize Your Team</h3>
          <p class="text-secondary mb-4">Lock in your team and set up an external group chat link (WhatsApp, Telegram, or Discord) so everyone can coordinate.</p>

          <div class="form-group">
            <label class="form-label">External Chat Link</label>
            <input type="url" class="form-input" placeholder="https://chat.whatsapp.com/..." id="chatLink">
          </div>

          <div class="flex gap-3">
            <button class="btn btn-primary" onclick="alert('Team finalized! (Demo)')">Lock Team</button>
            <button class="btn btn-secondary" onclick="showStep(2)">‚Üê Back</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  function showStep(n) {
    [1,2,3].forEach(s => {
      document.getElementById('step' + s).style.display = s === n ? '' : 'none';
      const chip = document.getElementById('step' + s + 'Chip');
      if (chip) chip.style.opacity = s === n ? '1' : '0.5';
    });
  }
</script>

<%- include('../partials/footer') %>
