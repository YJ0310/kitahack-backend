<%- include('../partials/head') %>

<%- include('../partials/sidebar_student') %>
<div class="sidebar-overlay" onclick="closeSidebar()"></div>

<div class="app-layout">
  <div class="main-content">
    <div class="mobile-header">
      <button class="hamburger-btn" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
      </button>
      <div class="logo-area">
        <span style="font-size:24px">üçµ</span>
        <span class="font-bold">Profile</span>
      </div>
      <button class="theme-pill" onclick="toggleTheme()">
        <span class="theme-icon">‚òÄÔ∏è</span>
      </button>
    </div>

    <%- include('../partials/topbar', { shell: 'student' }) %>

    <div class="page-content">
      <!-- Profile Header Cards -->
      <div class="grid grid-2" style="margin-bottom:32px;">
        <!-- Profile Info Card -->
        <div class="card" style="display:flex;align-items:center;gap:24px;">
          <div class="avatar" style="width:80px;height:80px;font-size:28px;">
            <%= (user.name || 'S').charAt(0) %>
          </div>
          <div>
            <h2 style="margin-bottom:4px;"><%= user.name || 'Student' %></h2>
            <div class="text-secondary" style="margin-bottom:4px;"><%= user.email || '' %></div>
            <div class="flex gap-2" style="flex-wrap:wrap;margin-top:8px;">
              <span class="chip chip-secondary"><%= user.role || 'student' %></span>
              <% if (user.matric_no) { %>
                <span class="chip chip-primary"><%= user.matric_no %></span>
              <% } %>
              <% if (user.major_id) { %>
                <span class="chip" style="background:#14B8A620;color:#14B8A6;">Major #<%= user.major_id %></span>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Quick Stats Card -->
        <div class="card">
          <h3 class="mb-3">Quick Stats</h3>
          <div class="stats-grid" style="grid-template-columns:repeat(2,1fr);">
            <div class="stat-card">
              <div class="stat-number"><%= (user.skillTags || []).length %></div>
              <div class="stat-label">Skills</div>
            </div>
            <div class="stat-card">
              <div class="stat-number"><%= matchCount %></div>
              <div class="stat-label">Matches</div>
            </div>
            <div class="stat-card">
              <div class="stat-number"><%= eventCount %></div>
              <div class="stat-label">Events</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">0</div>
              <div class="stat-label">Posts</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Personal Info -->
      <div class="card mb-4">
        <h3 class="mb-3">
          <span class="material-icons-round" style="vertical-align:middle;margin-right:8px;font-size:20px;">person</span>
          Personal Information
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;">
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">Full Name</label>
            <div class="font-semibold"><%= user.name || '-' %></div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">Email</label>
            <div class="font-semibold"><%= user.email || '-' %></div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">Role</label>
            <div class="font-semibold" style="text-transform:capitalize;"><%= user.role || 'student' %></div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">Matric No.</label>
            <div class="font-semibold"><%= user.matric_no || '-' %></div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">WhatsApp</label>
            <div class="font-semibold"><%= user.whatsapp_num || '-' %></div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">Major ID</label>
            <div class="font-semibold"><%= user.major_id || '-' %></div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">Portfolio / GitHub</label>
            <div class="font-semibold">
              <% if (user.portfolio_url) { %>
                <a href="<%= user.portfolio_url %>" target="_blank" class="text-primary"><%= user.portfolio_url %></a>
              <% } else { %>
                -
              <% } %>
            </div>
          </div>
          <div>
            <label class="text-xs text-secondary" style="display:block;margin-bottom:4px;">User ID</label>
            <div class="font-semibold text-xs" style="word-break:break-all;"><%= user.uid || '-' %></div>
          </div>
        </div>
      </div>

      <!-- Skills & Tags -->
      <div class="card mb-4">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3>
            <span class="material-icons-round" style="vertical-align:middle;margin-right:8px;font-size:20px;">local_offer</span>
            Skills &amp; Tags
          </h3>
          <button class="btn btn-primary btn-sm" onclick="openTagEditor()">
            <span class="material-icons-round" style="font-size:16px;margin-right:4px;">edit</span>
            Edit Tags
          </button>
        </div>

        <div class="flex gap-2" style="flex-wrap:wrap;" id="tagList">
          <% if (user.skillTags && user.skillTags.length > 0) { %>
            <% user.skillTags.forEach(tag => { %>
              <span class="chip <%= tag.is_confirmed ? 'chip-primary' : 'chip-secondary' %>" title="<%= tag.is_confirmed ? 'Confirmed' : 'Unconfirmed' %>">
                <%= tag.name %>
                <% if (!tag.is_confirmed) { %><span style="opacity:0.6;"> ‚è≥</span><% } %>
              </span>
            <% }); %>
          <% } else { %>
            <div class="text-secondary">No skills added yet.</div>
          <% } %>
          <% if (user.devTags && user.devTags.length > 0) { %>
            <div style="width:100%;margin-top:12px;">
              <div class="text-xs font-semibold text-secondary mb-2" style="text-transform:uppercase;letter-spacing:1px;">Dev / Tech Tags</div>
              <div class="flex gap-2" style="flex-wrap:wrap;">
                <% user.devTags.forEach(tag => { %>
                  <span class="chip chip-purple"><%= tag %></span>
                <% }); %>
              </div>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Available Tags Selector (hidden by default) -->
      <div class="card mb-4" id="tagEditor" style="display:none;">
        <h3 class="mb-3">
          <span class="material-icons-round" style="vertical-align:middle;margin-right:8px;font-size:20px;">tune</span>
          Select Your Skills
        </h3>
        <p class="text-secondary text-sm mb-3">Click tags to toggle them. Changes are saved automatically.</p>

        <% if (typeof allTags !== 'undefined') { %>
          <% Object.keys(allTags).forEach(category => { %>
            <div style="margin-bottom:16px;">
              <div class="text-xs font-semibold text-secondary mb-2" style="text-transform:uppercase;letter-spacing:1px;"><%= category %></div>
              <div class="flex gap-2" style="flex-wrap:wrap;">
                <% allTags[category].forEach(tag => { %>
                  <% const isActive = user.tags && user.tags.includes(tag); %>
                  <span class="chip <%= isActive ? 'chip-primary' : '' %>" style="cursor:pointer;" onclick="toggleTag(this, '<%= tag %>')">
                    <%= tag %>
                  </span>
                <% }); %>
              </div>
            </div>
          <% }); %>
        <% } %>

        <div style="margin-top:16px;display:flex;gap:8px;">
          <button class="btn btn-primary btn-sm" onclick="saveTags()">Save Changes</button>
          <button class="btn btn-outline btn-sm" onclick="closeTagEditor()">Cancel</button>
        </div>
      </div>

      <!-- Recent Matches -->
      <div class="card mb-4">
        <h3 class="mb-3">
          <span class="material-icons-round" style="vertical-align:middle;margin-right:8px;font-size:20px;">handshake</span>
          Recent Matches
        </h3>
        <% if (matches.length > 0) { %>
          <div class="grid grid-3">
            <% matches.slice(0, 6).forEach(match => { %>
              <div class="match-card">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                  <div class="flex items-center gap-2">
                    <div class="avatar" style="width:28px;height:28px;font-size:10px;"><%= (match.match_type || 'M').charAt(0).toUpperCase() %></div>
                    <div class="font-semibold text-sm"><%= match.match_type || 'Match' %></div>
                  </div>
                  <span class="chip chip-secondary" style="font-size:11px;"><%= match.score ? Math.round(match.score * 100) + '%' : '‚Äî' %></span>
                </div>
                <div class="text-xs text-secondary"><%= match.reason || '' %></div>
                <div class="text-xs text-secondary mt-2">
                  Status: <span style="text-transform:capitalize;"><%= match.match_status || 'pending' %></span>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="text-secondary text-center" style="padding:24px;">No matches yet. Keep building your profile!</div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedTags = <%= JSON.stringify((user.skillTags || []).map(t => t.name)) %>;

  function openTagEditor() {
    document.getElementById('tagEditor').style.display = 'block';
    document.getElementById('tagEditor').scrollIntoView({ behavior: 'smooth' });
  }
  function closeTagEditor() {
    document.getElementById('tagEditor').style.display = 'none';
  }

  function toggleTag(el, tag) {
    const idx = selectedTags.indexOf(tag);
    if (idx >= 0) {
      selectedTags.splice(idx, 1);
      el.classList.remove('chip-primary');
    } else {
      selectedTags.push(tag);
      el.classList.add('chip-primary');
    }
  }

  async function saveTags() {
    try {
      const res = await fetch('/api/profile/student/tags', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: '<%= user.uid %>', tags: selectedTags })
      });
      if (res.ok) {
        const tagList = document.getElementById('tagList');
        tagList.innerHTML = selectedTags.map(t => '<span class="chip chip-primary">' + t + '</span>').join('');
        closeTagEditor();
      }
    } catch (err) {
      console.error('Failed to save tags:', err);
    }
  }
</script>

<%- include('../partials/footer') %>
